---
title: "MCF7 SRSF1 Example"
author: "Harry Taegyun Yang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## SPARKS example - MCF7 SRSF1 shRNA

This example shows how to run the core steps of SPARKS. SRSF1 shRNA KD in MCF7 is chosen, as this cell line is not part of the reference library, and the perturbed RBP is known (SRSF1). The data in this example is generated by [Du et al.](https://jeccr.biomedcentral.com/articles/10.1186/s13046-021-01978-8) (Geo Accession No: [GSE163025](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE163025)).

### Running SPARKS analysis

#### Loading the necessary packages

```{r library, warning=FALSE}
library(SPARKS)  # load the SPARKS library 
library(data.table)  # load data.table for reading the input data 
library(dplyr)


```

#### Loading the input data from MCF7 SRSF1 shRNA

SPARKS provides a fully automated analysis pipeline, from fastq files to packaged end-result R object. We are using the packaged analysis data here.

```{r inputdata, warning=FALSE}
# read in the packaged SPARKS object
input_sparks_file <- "MCF7_SRSF1_shRNA.SPARKS.rds"
input_sparks <- readRDS(input_sparks_file)

# define study name
input_study <- "MCF7_SRSF1_shRNA"

# read in the input MATS
# - this function will only keep the known AS events, which is necessary
input_mats_df <- import_SPARKS_MATS_for_analysis(input_sparks, "SE") 
```

#### Loading pre-computed SPARKS analysis result

SPARKS snakemake pipeline automatically performs SPARKS analysis as the final step. Thus, you can access the SPARKS analysis result directly from the object.

```{r test_result_load}

sparks_analysis_result <- input_sparks@SPARKS_analysis_result$SE

head(sparks_analysis_result)
```

#### Performing SPARKS analysis

While the SPARKS object for the study has the SPARKS analysis result stored, we demonstrate the usage of SPARKS analysis functions here.

SPARKS library needs to be loaded to run SPARKS analysis.

Please note that SPARKS analysis can be computationally intensive, and might take up to 30 minutes to run.

```{r analysis, eval=FALSE}

# read in the library 
signature_library_file <- "../../library/SPARKS.ENCODE_signatures.library.rds"
signature_library <- readRDS(signature_library_file)$SE  # keep the SE parts only for memory management

# perform SPARKS analysis
sparks_analysis_result <- perform_SPARKS_analysis_with_overlap_filter(input_mats_df,
  signature_library,
  input_study)

head(sparks_analysis_result)
```

#### Visualize SPARKS analysis results 

SPARKS analysis results can be visualized using `generate_enrichment_barplot()` function. As we know SRSF1 is the RBP responsible for the AS change in this data set, we will denote RBP perturbation experiments with SRSF1 KD in red.

```{r barplot}
library(ggplot2)
generate_enrichment_barplot(sparks_analysis_result,
                            bar_color = "steelblue",  # set the bar color
                            num_plot = 10,  # plot top 10 based on abs ES
                            manual_colors = c("SRSF1" = "red")  # denote SRSF1
                            )

```
